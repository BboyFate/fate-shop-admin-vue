<template>
  <div class="createPost-container">
    <el-form
      ref="postForm"
      :model="postForm"
      :rules="rules"
      class="form-container"
      label-width="150px"
    >
      <sticky :z-index="10" :class-name="'sub-navbar'">
        <OnSaleDropdown v-model="postForm.on_sale" />
        <el-button v-loading="loading" style="margin-left: 10px;" type="success" @click="submitForm">
          提交
        </el-button>
      </sticky>

      <div class="createPost-main-container">
        <h3>基本信息</h3>
        <el-form-item label="商品名称" prop="title">
          <el-input v-model="postForm.title" placeholder="" clearable />
        </el-form-item>
        <el-form-item label="商品长标题" prop="long_title">
          <el-input v-model="postForm.long_title" placeholder="" clearable />
        </el-form-item>
        <el-form-item label="货号" prop="number">
          <el-input v-model="postForm.number" class="app-input-small" placeholder="可输入货号" clearable />
        </el-form-item>
        <el-form-item label="运费模板" prop="express_fee_id">
          <el-select v-model="postForm.express_fee_id" placeholder="请选择运费模板" clearable>
            <el-option
              v-for="(expressFee, expressFeeIndex) in expressFees"
              :key="expressFeeIndex"
              :label="expressFee.name"
              :value="expressFee.id"/>
          </el-select>
        </el-form-item>
        <el-form-item label="商品封面图" prop="image">
          <ul class="el-upload-list el-upload-list--picture-card">
            <li v-if="postForm.image" class="el-upload-list__item" @click="isSelectImageShowed=true">
              <img :src="postForm.image">
            </li>
            <div v-else class="el-upload el-upload--picture-card" @click="isSelectImageShowed=true">
              <i class="el-icon-picture" />
            </div>
          </ul>
        </el-form-item>
        <el-form-item label="商品轮播图" prop="banners">
          <ul class="el-upload-list el-upload-list--picture-card">
            <li v-for="(banner, bannerIndex) in postForm.banners" class="el-upload-list__item">
              <img :src="banner">
              <span class="el-upload-list__item-actions">
                <span class="el-upload-list__item-delete" @click="handleDeleteBanner(bannerIndex)">
                  <i class="el-icon-delete" />
                </span>
              </span>
            </li>
            <div v-if="postForm.banners && postForm.banners.length < 2" class="el-upload el-upload--picture-card" @click="handleAddBanner">
              <i class="el-icon-plus" />
            </div>
          </ul>
          <div class="el-upload__tip">最多可上传 5 张</div>
        </el-form-item>

        <h3>商品类目</h3>
        <el-form-item label="类目" prop="category_id">
          <el-cascader
            v-model="postForm.category_id"
            :options="this.categories"
            :props="{ expandTrigger: 'hover' }"
            clearable
          />
        </el-form-item>

        <template v-if="this.productType === 'crowdfunding'">
          <h3>众筹商品参数</h3>
          <el-form-item label="众筹目标金额" prop="crowdfunding">
            <el-input-number v-model="postForm.crowdfunding.target_amount" :min="0.01" />
          </el-form-item>

          <el-form-item label="众筹结束时间" prop="crowdfunding">
            <el-date-picker
              v-model="postForm.crowdfunding.end_at"
              type="datetime"
              placeholder="选择日期时间"
              align="right"
              value-format="yyyy-MM-dd HH:mm:ss"
              :picker-options="crowdfundingEndAtOptions"
            />
          </el-form-item>
        </template>

        <h3>商品详情</h3>
        <el-form-item prop="description" style="margin-bottom: 30px;">
          <Tinymce ref="editor" v-model="postForm.description.description" :height="400" />
        </el-form-item>

        <product-sku ref="productSkus" />
      </div>
    </el-form>

    <fate-image :is-showed.sync="isSelectImageShowed" @get-selected-images="handleSelectedImages" />
  </div>
</template>

<script>
import FateImage from '@/components/FateImage'
import Tinymce from '@/components/Tinymce'
import Sticky from '@/components/Sticky' // 粘性header组件
import ProductSku from '@/components/ProductSku'
import { OnSaleDropdown } from './Dropdown'

import {
  getProductDetail,
  updateProduct,
  addProduct,
  addCrowdfundingProduct,
  updateCrowdfundingProduct
} from '@/api/products/product'
import { generateCategorySelector } from '@/utils'
import { getFees } from '@/api/systems/express'

const defaultForm = {
  id: 0,
  title: '', // 商品名称
  long_title: '', // 商品长标题
  number: '', // 商品货号
  image: '', // 图片
  banners: [],
  on_sale: false,
  category_id: undefined,
  skus: [],
  description: {
    description: ''
  },
  crowdfunding: {
    target_amount: 0,
    end_at: undefined
  }
}

export default {
  name: 'ProductDetail',
  components: {
    Tinymce,
    Sticky,
    FateImage,
    ProductSku,
    OnSaleDropdown
  },
  filters: {
    attrFilter(attr) {
      let str = ''
      for (const item of attr) {
        str += [item.name] + ':' + item.value + '; '
      }
      return str
    }
  },
  props: {
    isEdit: {
      type: Boolean,
      required: true
    },
    productType: {
      type: String,
      required: true,
      validator: function(value) {
        return [
          'normal',
          'crowdfunding'
        ].indexOf(value) !== -1
      }
    }
  },
  data() {
    return {
      postForm: Object.assign({}, defaultForm),
      categories: [], // 所有分类
      expressFees: [], // 运费模板
      loading: false,

      isSelectImageShowed: false, // 显示图片库
      imageOrigin: '',

      crowdfundingEndAtOptions: {
        shortcuts: [{
          text: '明天',
          onClick(picker) {
            const date = new Date()
            date.setTime(date.getTime() + 3600 * 1000 * 24)
            picker.$emit('pick', date)
          }
        }, {
          text: '一周后',
          onClick(picker) {
            const date = new Date()
            date.setTime(date.getTime() + 3600 * 1000 * 24 * 7)
            picker.$emit('pick', date)
          }
        }],
        disabledDate(time) {
          // 此条为设置禁止用户选择今天之前的日期，包含今天。
          // return time.getTime() <= (Date.now());
          // 此条为设置禁止用户选择今天之前的日期，不包含今天。
          return time.getTime() <= (Date.now() - (24 * 60 * 60 * 1000))
        }
      },
      rules: {
        title: [
          {required: true, message: '请输入商品标题', trigger: 'blur'}
        ],
        long_title: [
          {required: true, message: '请输入商品长标题', trigger: 'blur'}
        ],
        number: [
          {required: false, message: '请输入商品货号', trigger: 'blur'}
        ],
        image: [
          {required: true, message: '请上传商品主图', trigger: 'change'}
        ],
        banners: [
          {required: true, message: '请上传商品轮播图', trigger: 'change'}
        ],
        category_id: [
          {required: true, message: '请设置商品所属类目', trigger: 'blur'}
        ],
        crowdfunding: {
          type: 'object',
          required: false,
          fields: {
            target_amount: { type: 'number', required: true, trigger: 'blur', message: '众筹金额必须填写' },
            end_at: { required: true, trigger: 'blur', message: '众筹结束日期必须填写' }
          }
        },
        description: {
          type: 'object',
          required: true,
          fields: {
            description: { required: true, message: '请输入商品详情描述', trigger: 'blur' }
          }
        }
      }
    }
  },
  created() {
    if (this.isEdit) {
      this.postForm.id = this.$route.params && this.$route.params.id
    }
    this.getProductDetail(this.postForm.id)
    this.getExpressFees()
  },
  methods: {
    /**
     * 删除商品某张轮播图
     */
    handleDeleteBanner(bannerIndex) {
      this.postForm.banners.splice(bannerIndex, 1)
    },
    /**
     * 添加商品轮播图
     */
    handleAddBanner() {
      this.imageOrigin = 'banner'
      this.isSelectImageShowed = true
    },

    /**
     * 选择图片库的图片，保存到商品主图
     */
    handleSelectedImages(images) {
      if (this.imageOrigin == 'banner') {
        this.postForm.banners.push(images[0].path)
      } else {
        this.postForm.image = images[0].path
      }

      this.imageOrigin = ''
    },

    /**
     * 获取商品详情
     */
    async getProductDetail(id) {
      await getProductDetail(id, {
        include: 'crowdfunding,category,skus,attributes,description'
      }).then(response => {
        if (response.data.product) {
          this.postForm = response.data.product
          this.$refs.productSkus._setData(response.data.product.skus)
        }
        this.categories = generateCategorySelector(response.data.categories)
        this.$refs.productSkus._setProductAttrTemplates(response.data.attribute_templates)
      }).catch(err => {
        console.log(err)
      })
    },
    /**
     * 获取运费模板
     */
    async getExpressFees() {
      await getFees().then(response => {
        this.expressFees = response.data
      }).catch(err => {
        console.log(err)
      })
    },

    /**
     * 获取 SKU 列表
     */
    getSkuData() {
      return this.$refs.productSkus._getData().map(sku => {
        const {
          id,
          name,
          image,
          price,
          stock,
          weight,
          volume,
          _attributes
        } = sku

        const skuText = _attributes.reduce(
          (prev, current) => `${prev}${current.name}—${current.value} ;`,
          ''
        )

        if (!price) {
          this.$message.error(skuText + ' 未输入销售价')
          throw new Error('请输入销售价')
        } else if (!stock) {
          this.$message.error(skuText + ' 未输入库存')
          throw new Error('请输入库存')
        } else if (!image) {
          this.$message.error(skuText + ' 未添加图片')
          throw new Error('请添加图片')
        } else if (!weight) {
          this.$message.error(skuText + ' 未设置重量')
          throw new Error('请设置重量')
        } else if (!volume) {
          this.$message.error(skuText + ' 未设置体积')
          throw new Error('请设置体积')
        }

        return {
          id,
          name,
          image,
          price,
          stock,
          weight,
          volume,
          attributes: _attributes.map(attribute => ({
            name: attribute.name,
            value: attribute.value
          }))
        }
      })
    },

    /**
     * 获取商品规格
     */
    getProductAttributes() {
      return this.$refs.productSkus._getProductAttributes().map(attr => {
        return {
          name: attr.name,
          values: attr.values.map(item => item.value)
        }
      })
    },

    /**
     * 提交表单
     */
    submitForm() {
      this.$refs.postForm.validate(async(valid) => {
        if (valid) {
          if (this.postForm.category_id.length > 0) {
            this.postForm.category_id = this.postForm.category_id.pop()
          }

          const postForm = this.postForm
          const postData = {
            title: postForm.title,
            long_title: postForm.long_title,
            type: this.productType,
            image: postForm.image,
            banners: postForm.banners,
            on_sale: postForm.on_sale,
            category_id: postForm.category_id,
            express_fee_id: postForm.express_fee_id,
            skus: this.getSkuData(),
            attributes: this.getProductAttributes(),
            description: postForm.description.description
          }

          if (!postData.attributes || postData.attributes.length == 0) {
            this.msgError('商品规格必须填写')
            return false
          }

          this.loading = true
          // 如果是众筹商品
          if (this.productType === 'crowdfunding') {
            postData.target_amount = postForm.crowdfunding.target_amount
            postData.end_at = postForm.crowdfunding.end_at

            if (this.isEdit) {
              await updateCrowdfundingProduct(postForm.id, postData)
                .then((res) => {
                  this.postForm = res.data
                  this.msgSuccess('编辑众筹商品成功')
                })
            } else {
              await addCrowdfundingProduct(postData)
                .then((res) => {
                  this.postForm = res.data
                  this.msgSuccess('新增众筹商品成功')
                })
            }
          } else {
            // 普通商品
            if (this.isEdit) {
              await updateProduct(postForm.id, postData)
                .then((res) => {
                  this.postForm = res.data
                  this.msgSuccess('编辑商品成功')
                })
            } else {
              await addProduct(postData)
                .then((res) => {
                  this.postForm = res.data
                  this.msgSuccess('新增商品成功')
                })
            }
            setTimeout(this.$router.back(-1), 2000)
          }
          this.loading = false
        } else {
          console.log('error submit!!')
          return false
        }
      })
    },
  }
}
</script>

<style lang="scss" scoped>
  @import "~@/assets/styles/mixin.scss";

  .createPost-container {
    position: relative;

    .createPost-main-container {
      padding: 20px 80px 20px 80px;

      .postInfo-container {
        position: relative;
        @include clearfix;
        margin-bottom: 10px;

        .postInfo-container-item {
          float: left;
        }
      }
    }

    .word-counter {
      width: 40px;
      position: absolute;
      right: 10px;
      top: 0px;
    }
  }

  .el-tag + .el-tag {
    margin-left: 10px;
  }
  .button-new-tag {
    margin-left: 10px;
    height: 32px;
    line-height: 30px;
    padding-top: 0;
    padding-bottom: 0;
  }
  .input-new-tag {
    width: 90px;
    margin-left: 10px;
    vertical-align: bottom;
  }
</style>
